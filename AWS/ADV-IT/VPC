Виртуальные сети 

VPC - Virtual Private Cloud 
1. VPC - CIDR blocks (CIDR blocks - это диапазон ip адресов, которые работают в этой сети)
К одной VPC можно добавить несколько CIDR блоков.
2. Public Subnet - часть сети VPC, где большую сеть мы разделяем на подсети. Есть прямой доступ в интернет.
3. Private Subnet - часть сети VPC, нет public ip. Напрямую не могут выйти в интернет напрямую. Могут только через NAT сервер.
4. Database Subnet - тот же Private Subnet, но нет выхода в интернет вообще.
5. Route Table - таблица, в которой мы приаттачиваем сети
6. Internet Gateway - с помощью него есть доступ в интернет
7. NAT Gateway - сервер, который мы создаем и кладем его в Public Subnet. И через этот шлюз Private Subnet сможет выйти в интернет.
8. NAT Instance - сервер, который имеет доступ в интернет.
9. Security Group - фаерволл роли. Открываются in и out.
10. Network Access Control List - нужно самим открывать на in и на out. Тоже фаерволл роли. Можно и разрешить, и запретить открывать порты
11. Bastion Host - у него есть доступ в интернет. У него есть доступ ко всем остальным интсансам. Нужно, когда все-таки хотим залезть на сервер в Private Subnet и чото-то посмотреть.
12. VPC flow Logs - логи
13. VPN Gateway - коннект не через интернет, а через VPN. И как будто все работает локально 
14. VPN Gateway - как соединять сети 

NAT Gatway должен быть в каждой avialability zone, по хорошему
10.0.0.0/16 - 65 535 IP адресов - минус 5 ip адресов зарезервированных AWS 
Самый большой диапазон, 10.0 - постоянные, а остальные меняются 

10.0.0.0/24 - 254 ip адресов - минус 5 ip адресов зарезервированных AWS 
10.0.0 - постоянные, остальные меняются 
10.0.0.0/28 - 16 ip адресов  - минус 5 ip адресов зарезервированных AWS 
Самый маленький диапазон

CIDR: 10.0.10.0/24 
- 10.0.10.0: Network address
- 10.0.10.1: Reserved by AWS
- 10.0.10.2: Reserved by AWS
- 10.0.10.3: Reserved by AWS
- 10.0.10.255: Reserved by AWS

Local Network IP Range: 
10.0.0.0 - 10.255.255.255
172.16.0.0 - 172.31.255.255
192.168.0.0 - 192.168.255.255

Public Subnet - все серверы имеют PublicIp и прямой доступ в Интернет 
Private Subnet - все серверы НЕ имеют PublicIp и имеют доступ в интернет через NAT 
Database Subnet - все серверы НЕ имеют PublicIp и НЕ имеют доступ в интернет

Subnet CIDR Block должен быть в зоне VPC CIDR Block
VPC CIDR: 10.0.0.0/16
Subnet CIDR: 
- 10.0.10.0/24 -> Servers IP range (10.0.10.0 - 10.0.10.255)
- 10.0.11.0/24 -> Servers IP range (10.0.11.0 - 10.0.11.255)
- 10.0.12.0/24 -> Servers IP range (10.0.12.0 - 10.0.12.255)
- 10.0.20.0/24 -> Servers IP range (10.0.20.0 - 10.0.20.255)
- 10.0.21.0/24 -> Servers IP range (10.0.21.0 - 10.0.21.255)
- 10.0.22.0/24 -> Servers IP range (10.0.22.0 - 10.0.22.255)

К одной VPC можно приаттачить только ОДИН Internet Gateway 
Один Subnet - ОДНА Availability zone 

Чтобы был доступ в интернет через Internet Gateway, нужно отредачить Route table. И добавить туда Internet Gateway 
По умолчанию Network ACL - пропускает весь трафик in и out 
Необходимо создать новый Security Group и к нему приаттачить новый VPC 


VPC Flow Logs 
Лог файлы всех сетевых пакетов в вашей сети, на уровне:
1. VPC
2. Subnet
3. Network Interface 

Прежде всего нужно создать 
IAM Role и указать разрешение записывать события с ClowdWatch Logs 
CloudWatch - мониторинг ресурсов 

VPC Peering - это соединение VPC сетей, дает возможность общения серверов в одной VPC серверами в другой VPC, используя PrivateIP адреса.
Соединить можно только сети в одном и том же регионе AWS.
И только если CIDR Block не прекращается, то есть нет одинаковых адрессов.

Для трех VPC должно быть 3 VPC Peereing:
VPC 1 - VPC 2 
VPC 2 - VPC 3
VPC 3 - VPC 1

VPN
1. Virtual Private Gateway - создается в VPC 
2. Customer Gateway - создается в вашей (домашней, офисной) сети 

VPC-peering
VPC-peering - соединение VPC сетей, дает возможность общения серверов с одной VPC с серверами 
в другой VPC, используя PrivateIP адресса и не используя Интернет, используется внутрення Инфраструктура AWS.

Соединить можно:
- в одном и том же регионе AWS - in-region VPC peering 
- в разных регионах AWS - inter-region VPC peering 
- в разных аккаунтах и разных регионах AWS - Cross-account VPC peering 

ВАЖНО! CIDR Block сетей не должны перекрещиваться, т.е. нет одинаковых адрессов.
VPC A <------------X------------>VPC B 
172.16.0.0/16                 172.16.0.0/16 
Так не будет работать!


